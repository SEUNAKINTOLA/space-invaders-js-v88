"""
Game Systems Integration Validation Script
Validates the integration and functionality of all game systems for Space Invaders JS V88

Author: AI Assistant
Created: 2024
"""

import json
import logging
import os
# TODO: Fix import - from dataclasses import dataclass
# TODO: Fix import - from enum import Enum
from typing import Dict, List, Optional, Tuple
from datetime import datetime

from app.config.logging import configure_logging
from app.api.models.intelligence_models import ProjectStatus, JSON
from app.code_analysis.treesitter.enhanced_models import ProjectStructure, AnalysisMode

# Configure logging
logger = configure_logging(__name__)

class ValidationStatus(Enum):
    """Validation status enumeration"""
    PASSED = "PASSED"
    FAILED = "FAILED"
    WARNING = "WARNING"
    SKIPPED = "SKIPPED"

@dataclass
class SystemValidationResult:
    """Data class to store validation results for a single system"""
    system_name: str
    status: ValidationStatus
    details: str
    dependencies: List[str]
    timestamp: datetime

class GameSystemValidator:
    """Main validator class for game systems integration"""

    def __init__(self, project_root: str):
        """
        Initialize the validator
        
        Args:
            project_root: Root directory of the project
        """
        self.project_root = project_root
        self.results: List[SystemValidationResult] = []
        self.required_systems = {
            "AudioManager": ["src/systems/AudioManager.js", "src/constants/AudioConstants.js"],
            "ScoreManager": ["src/systems/ScoreManager.js", "src/ui/ScoreDisplay.js"],
            "WaveManager": ["src/systems/WaveManager.js"],
            "InputManager": ["src/engine/InputManager.js"],
            "GameEngine": ["src/engine/GameEngine.js", "src/engine/State.js"],
            "PlayerController": ["src/controllers/PlayerController.js"]
        }

    def validate_file_existence(self, filepath: str) -> bool:
        """
        Check if required file exists
        
        Args:
            filepath: Path to the file to check
            
        Returns:
            bool: True if file exists, False otherwise
        """
        full_path = os.path.join(self.project_root, filepath)
        return os.path.exists(full_path)

    def validate_system_dependencies(self, system_name: str, files: List[str]) -> Tuple[ValidationStatus, str]:
        """
        Validate dependencies for a specific system
        
        Args:
            system_name: Name of the system to validate
            files: List of required files for the system
            
        Returns:
            Tuple containing ValidationStatus and details string
        """
        missing_files = []
        for file_path in files:
            if not self.validate_file_existence(file_path):
                missing_files.append(file_path)

        if missing_files:
            return (
                ValidationStatus.FAILED,
                f"Missing required files: {', '.join(missing_files)}"
            )
        return (ValidationStatus.PASSED, "All required files present")

    def validate_integration_points(self, system_name: str) -> Optional[str]:
        """
        Validate integration points for a system
        
        Args:
            system_name: Name of the system to validate
            
        Returns:
            Optional[str]: Warning message if any, None if all good
        """
        integration_warnings = []
        
        # System-specific integration checks
        if system_name == "AudioManager":
            if not self.validate_file_existence("src/assets/sounds"):
                integration_warnings.append("Audio assets directory missing")
                
        elif system_name == "ScoreManager":
            if not self.validate_file_existence("src/ui/ScoreDisplay.js"):
                integration_warnings.append("Score display UI component missing")
                
        elif system_name == "GameEngine":
            required_integrations = ["State.js", "Canvas.js"]
            for integration in required_integrations:
                if not self.validate_file_existence(f"src/engine/{integration}"):
                    integration_warnings.append(f"Missing core engine component: {integration}")

        return "; ".join(integration_warnings) if integration_warnings else None

    def validate_all_systems(self) -> None:
        """Validate all game systems and store results"""
        for system_name, required_files in self.required_systems.items():
            # Validate system dependencies
            status, details = self.validate_system_dependencies(system_name, required_files)
            
            # Check integration points
            integration_warning = self.validate_integration_points(system_name)
            if integration_warning and status == ValidationStatus.PASSED:
                status = ValidationStatus.WARNING
                details = f"{details}; Integration warnings: {integration_warning}"

            result = SystemValidationResult(
                system_name=system_name,
                status=status,
                details=details,
                dependencies=required_files,
                timestamp=datetime.now()
            )
            self.results.append(result)

    def generate_report(self) -> Dict:
        """
        Generate validation report
        
        Returns:
            Dict: Report in dictionary format
        """
        report = {
            "validation_timestamp": datetime.now().isoformat(),
            "project": "Space Invaders JS V88",
            "systems": []
        }

        for result in self.results:
            system_report = {
                "name": result.system_name,
                "status": result.status.value,
                "details": result.details,
                "dependencies": result.dependencies,
                "validated_at": result.timestamp.isoformat()
            }
            report["systems"].append(system_report)

        # Add summary statistics
        total_systems = len(self.results)
        passed_systems = len([r for r in self.results if r.status == ValidationStatus.PASSED])
        failed_systems = len([r for r in self.results if r.status == ValidationStatus.FAILED])
        warning_systems = len([r for r in self.results if r.status == ValidationStatus.WARNING])

        report["summary"] = {
            "total_systems": total_systems,
            "passed": passed_systems,
            "failed": failed_systems,
            "warnings": warning_systems,
            "success_rate": f"{(passed_systems/total_systems)*100:.2f}%"
        }

        return report

    def save_report(self, output_path: str) -> None:
        """
        Save validation report to file
        
        Args:
            output_path: Path to save the report
        """
        report = self.generate_report()
        try:
            with open(output_path, 'w') as f:
                json.dump(report, f, indent=2)
            logger.info(f"Validation report saved to {output_path}")
        except Exception as e:
            logger.error(f"Failed to save validation report: {str(e)}")

def main():
    """Main execution function"""
    try:
        # Initialize validator
        validator = GameSystemValidator("./")
        
        # Run validation
        validator.validate_all_systems()
        
        # Generate and save report
        report_path = "docs/validation_report.json"
        validator.save_report(report_path)
        
        # Log summary
        report = validator.generate_report()
        logger.info("Validation Summary:")
        logger.info(f"Total Systems: {report['summary']['total_systems']}")
        logger.info(f"Passed: {report['summary']['passed']}")
        logger.info(f"Failed: {report['summary']['failed']}")
        logger.info(f"Warnings: {report['summary']['warnings']}")
        logger.info(f"Success Rate: {report['summary']['success_rate']}")
        
    except Exception as e:
        logger.error(f"Validation failed: {str(e)}")
        raise

if __name__ == "__main__":
    main()